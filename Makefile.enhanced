# Makefile Enhanced pour SelfStart
# Commandes avanc√©es pour l'orchestration et le load balancing

.PHONY: help install start stop restart status logs clean build update

# Variables
COMPOSE_FILE = docker-compose.enhanced.yml
APPS_COMPOSE_FILE = examples/docker-compose.apps.yml
PROJECT_NAME = selfstart-enhanced

# Couleurs pour les messages
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## Affiche l'aide Enhanced
	@echo "$(GREEN)SelfStart Enhanced - Commandes disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Profils disponibles:$(NC)"
	@echo "  ha          - High Availability (instances multiples)"
	@echo "  monitoring  - Prometheus + Grafana"
	@echo "  dashboard   - Interface d'administration"
	@echo "  apps        - Applications d'exemple"

install-enhanced: ## Installation Enhanced avec orchestration
	@echo "$(GREEN)üöÄ Installation SelfStart Enhanced...$(NC)"
	@chmod +x start.sh
	@./start.sh
	@echo "$(GREEN)‚úÖ Installation Enhanced termin√©e$(NC)"

start-enhanced: ## D√©marre SelfStart Enhanced
	@echo "$(GREEN)‚ñ∂Ô∏è  D√©marrage SelfStart Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)‚úÖ SelfStart Enhanced d√©marr√©$(NC)"

start-ha: ## D√©marre en mode High Availability
	@echo "$(GREEN)üîÑ D√©marrage en mode High Availability...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) --profile ha up -d
	@echo "$(GREEN)‚úÖ Mode HA activ√©$(NC)"

start-full: ## D√©marre avec tous les profils
	@echo "$(GREEN)üöÄ D√©marrage complet (HA + Monitoring + Dashboard + Apps)...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) -f $(APPS_COMPOSE_FILE) \
		--profile ha --profile monitoring --profile dashboard --profile apps up -d
	@echo "$(GREEN)‚úÖ D√©marrage complet termin√©$(NC)"

stop-enhanced: ## Arr√™te SelfStart Enhanced
	@echo "$(YELLOW)‚èπÔ∏è  Arr√™t SelfStart Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)‚úÖ SelfStart Enhanced arr√™t√©$(NC)"

restart-enhanced: ## Red√©marre SelfStart Enhanced
	@echo "$(YELLOW)üîÑ Red√©marrage SelfStart Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) restart
	@echo "$(GREEN)‚úÖ SelfStart Enhanced red√©marr√©$(NC)"

status-enhanced: ## Affiche l'√©tat Enhanced
	@echo "$(GREEN)üìä √âtat SelfStart Enhanced:$(NC)"
	@docker-compose -f $(COMPOSE_FILE) ps

logs-enhanced: ## Affiche les logs Enhanced
	@echo "$(GREEN)üìã Logs SelfStart Enhanced (Ctrl+C pour quitter):$(NC)"
	@docker-compose -f $(COMPOSE_FILE) logs -f

build-enhanced: ## Reconstruit les images Enhanced
	@echo "$(GREEN)üî® Construction des images Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)‚úÖ Images Enhanced construites$(NC)"

# ===============================
# ORCHESTRATION
# ===============================

orchestrator-status: ## Statut de l'orchestrateur
	@echo "$(GREEN)üé≠ Statut de l'orchestrateur:$(NC)"
	@curl -s http://localhost:8000/api/v2/containers | jq '.metrics'

orchestrator-metrics: ## M√©triques de l'orchestrateur
	@echo "$(GREEN)üìä M√©triques de l'orchestrateur:$(NC)"
	@curl -s http://localhost:8000/api/v2/metrics | jq '.orchestrator'

create-container: ## Cr√©e un nouveau container (usage: make create-container NAME=myapp IMAGE=nginx:latest)
	@echo "$(GREEN)üì¶ Cr√©ation du container $(NAME)...$(NC)"
	@curl -X POST http://localhost:8000/api/v2/containers \
		-H "Content-Type: application/json" \
		-d '{"name":"$(NAME)","image":"$(IMAGE)","ports":{"80":8080}}'

start-container: ## D√©marre un container (usage: make start-container NAME=myapp)
	@echo "$(GREEN)‚ñ∂Ô∏è  D√©marrage du container $(NAME)...$(NC)"
	@curl -X POST http://localhost:8000/api/v2/containers/$(NAME)/start

stop-container: ## Arr√™te un container (usage: make stop-container NAME=myapp)
	@echo "$(YELLOW)‚èπÔ∏è  Arr√™t du container $(NAME)...$(NC)"
	@curl -X POST http://localhost:8000/api/v2/containers/$(NAME)/stop

container-logs: ## Logs d'un container (usage: make container-logs NAME=myapp)
	@echo "$(GREEN)üìã Logs du container $(NAME):$(NC)"
	@curl -s http://localhost:8000/api/v2/containers/$(NAME)/logs | jq -r '.logs'

# ===============================
# PROXY MANAGEMENT
# ===============================

proxy-status: ## Statut du proxy manager
	@echo "$(GREEN)üîÄ Statut du proxy:$(NC)"
	@curl -s http://localhost:8000/api/v2/proxy/targets | jq '.metrics'

proxy-targets: ## Liste les targets de proxy
	@echo "$(GREEN)üéØ Targets de proxy:$(NC)"
	@curl -s http://localhost:8000/api/v2/proxy/targets | jq '.targets'

create-proxy-target: ## Cr√©e un target de proxy (usage: make create-proxy-target NAME=myapp HOST=localhost PORT=8080)
	@echo "$(GREEN)üéØ Cr√©ation du target $(NAME)...$(NC)"
	@curl -X POST http://localhost:8000/api/v2/proxy/targets \
		-H "Content-Type: application/json" \
		-d '{"name":"$(NAME)","backends":[{"host":"$(HOST)","port":$(PORT)}],"rule":"round_robin"}'

add-backend: ## Ajoute un backend (usage: make add-backend TARGET=myapp HOST=localhost PORT=8081)
	@echo "$(GREEN)‚ûï Ajout du backend $(HOST):$(PORT) au target $(TARGET)...$(NC)"
	@curl -X POST http://localhost:8000/api/v2/proxy/targets/$(TARGET)/backends \
		-H "Content-Type: application/json" \
		-d '{"host":"$(HOST)","port":$(PORT),"weight":1}'

remove-backend: ## Retire un backend (usage: make remove-backend TARGET=myapp URL=http://localhost:8081)
	@echo "$(YELLOW)‚ûñ Suppression du backend $(URL) du target $(TARGET)...$(NC)"
	@curl -X DELETE "http://localhost:8000/api/v2/proxy/targets/$(TARGET)/backends?backend_url=$(URL)"

backend-maintenance: ## Met un backend en maintenance (usage: make backend-maintenance TARGET=myapp URL=http://localhost:8081 MODE=true)
	@echo "$(YELLOW)üîß Maintenance du backend $(URL): $(MODE)...$(NC)"
	@curl -X POST "http://localhost:8000/api/v2/proxy/targets/$(TARGET)/backends/maintenance?backend_url=$(URL)&maintenance=$(MODE)"

# ===============================
# MONITORING
# ===============================

start-monitoring: ## D√©marre le stack de monitoring
	@echo "$(GREEN)üìä D√©marrage du monitoring...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) --profile monitoring up -d
	@echo "$(GREEN)‚úÖ Monitoring disponible:$(NC)"
	@echo "  Prometheus: http://localhost:9090"
	@echo "  Grafana: http://localhost:3002 (admin/admin)"

metrics: ## Affiche toutes les m√©triques
	@echo "$(GREEN)üìä M√©triques syst√®me:$(NC)"
	@curl -s http://localhost:8000/api/v2/metrics | jq '.'

prometheus-metrics: ## M√©triques format Prometheus
	@echo "$(GREEN)üìä M√©triques Prometheus:$(NC)"
	@curl -s http://localhost:8000/metrics

health-check-all: ## V√©rifie la sant√© de tous les services
	@echo "$(GREEN)üè• V√©rification de sant√© globale:$(NC)"
	@echo "Backend Enhanced:"
	@curl -f http://localhost:8000/health 2>/dev/null && echo "  ‚úÖ Backend OK" || echo "  ‚ùå Backend KO"
	@echo "Frontend:"
	@curl -f http://localhost:3000 2>/dev/null && echo "  ‚úÖ Frontend OK" || echo "  ‚ùå Frontend KO"
	@echo "Redis:"
	@docker-compose -f $(COMPOSE_FILE) exec -T redis redis-cli ping 2>/dev/null && echo "  ‚úÖ Redis OK" || echo "  ‚ùå Redis KO"

# ===============================
# LOAD BALANCING
# ===============================

start-loadbalancer: ## D√©marre HAProxy
	@echo "$(GREEN)‚öñÔ∏è  D√©marrage du load balancer...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) --profile loadbalancer up -d
	@echo "$(GREEN)‚úÖ HAProxy disponible sur http://localhost:8080$(NC)"
	@echo "  Stats: http://localhost:8404/stats"

haproxy-stats: ## Affiche les stats HAProxy
	@echo "$(GREEN)üìä Stats HAProxy:$(NC)"
	@curl -s http://localhost:8404/stats

test-load-balancing: ## Test le load balancing
	@echo "$(GREEN)üß™ Test du load balancing...$(NC)"
	@for i in {1..10}; do \
		echo "Requ√™te $$i:"; \
		curl -s http://localhost:8080/health | jq -r '.service'; \
		sleep 1; \
	done

# ===============================
# D√âVELOPPEMENT
# ===============================

dev-enhanced: ## Mode d√©veloppement Enhanced
	@echo "$(GREEN)üõ†Ô∏è  Mode d√©veloppement Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) -f docker-compose.dev.yml up --build

test-enhanced: ## Lance les tests Enhanced
	@echo "$(GREEN)üß™ Tests Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) exec backend-api-enhanced python -m pytest tests/ -v

benchmark: ## Benchmark de performance
	@echo "$(GREEN)‚ö° Benchmark de performance...$(NC)"
	@echo "Test de charge sur l'API:"
	@ab -n 1000 -c 10 http://localhost:8000/health
	@echo "Test de charge sur le proxy:"
	@ab -n 1000 -c 10 http://localhost:8080/health

# ===============================
# MAINTENANCE
# ===============================

backup-enhanced: ## Sauvegarde Enhanced
	@echo "$(GREEN)üíæ Sauvegarde Enhanced...$(NC)"
	@mkdir -p backups/enhanced
	@docker run --rm -v selfstart-enhanced_redis_data:/data -v $(PWD)/backups/enhanced:/backup alpine tar czf /backup/redis_$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@docker run --rm -v selfstart-enhanced_prometheus_data:/data -v $(PWD)/backups/enhanced:/backup alpine tar czf /backup/prometheus_$(shell date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@cp .env backups/enhanced/env_$(shell date +%Y%m%d_%H%M%S).backup 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Sauvegarde Enhanced termin√©e$(NC)"

clean-enhanced: ## Nettoyage Enhanced
	@echo "$(YELLOW)üßπ Nettoyage Enhanced...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Nettoyage Enhanced termin√©$(NC)"

update-enhanced: ## Mise √† jour Enhanced
	@echo "$(GREEN)üì• Mise √† jour Enhanced...$(NC)"
	@git pull
	@docker-compose -f $(COMPOSE_FILE) down
	@docker-compose -f $(COMPOSE_FILE) build --no-cache
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)‚úÖ Mise √† jour Enhanced termin√©e$(NC)"

# ===============================
# UTILITAIRES
# ===============================

shell-backend: ## Shell dans le backend Enhanced
	@docker-compose -f $(COMPOSE_FILE) exec backend-api-enhanced /bin/bash

shell-redis: ## Shell dans Redis
	@docker-compose -f $(COMPOSE_FILE) exec redis redis-cli

network-info: ## Informations r√©seau Enhanced
	@echo "$(GREEN)üåê Informations r√©seau Enhanced:$(NC)"
	@docker network inspect selfstart-network | jq '.[0].Containers'

api-docs: ## Documentation API Enhanced
	@echo "$(GREEN)üìö Documentation API Enhanced:$(NC)"
	@echo "  Swagger UI: http://localhost:8000/docs"
	@echo "  ReDoc: http://localhost:8000/redoc"
	@echo "  API v2: http://localhost:8000/api/v2/"

# Affichage par d√©faut
.DEFAULT_GOAL := help