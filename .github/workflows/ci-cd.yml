name: SelfStart CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: kihw/selfstart

jobs:
  # Tests et validation du code
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests & Validation

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ“ Validate docker-compose
      run: |
        docker-compose config
        docker-compose -f docker-compose.yml -f examples/docker-compose.apps.yml config

    - name: ğŸ” Lint Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: backend-api/Dockerfile

    - name: ğŸ” Lint Dockerfile Frontend
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: frontend-loader/Dockerfile

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Python dependencies
      run: |
        cd backend-api
        pip install -r requirements.txt
        pip install pytest black flake8

    - name: ğŸ” Python code linting
      run: |
        cd backend-api
        black --check .
        flake8 . --max-line-length=88 --extend-ignore=E203

    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend-loader/package-lock.json

    - name: ğŸ“¦ Install Node.js dependencies
      run: |
        cd frontend-loader
        npm ci

    - name: ğŸ” JavaScript/React linting
      run: |
        cd frontend-loader
        npm run lint

    - name: ğŸ—ï¸ Build frontend
      run: |
        cd frontend-loader
        npm run build

  # Tests d'intÃ©gration avec Docker
  integration-test:
    runs-on: ubuntu-latest
    name: ğŸ”§ Integration Tests
    needs: test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸš€ Create test environment
      run: |
        cp .env.example .env
        sed -i 's/BASE_DOMAIN=exemple.com/BASE_DOMAIN=localhost/' .env

    - name: ğŸ—ï¸ Build and start services
      run: |
        docker-compose up -d --build
        sleep 30

    - name: ğŸ¥ Health check API
      run: |
        curl -f http://localhost:8000/health || exit 1
        curl -f http://localhost:8000/api/containers || exit 1

    - name: ğŸ¥ Health check Frontend
      run: |
        curl -f http://localhost:3000 || exit 1

    - name: ğŸ“‹ Show logs on failure
      if: failure()
      run: |
        docker-compose logs

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        docker-compose down -v

  # Construction et publication des images Docker
  build-and-push:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build & Push Images
    needs: [test, integration-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“ Extract metadata
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ“ Extract metadata frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ğŸ—ï¸ Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: backend-api
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ—ï¸ Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: frontend-loader
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Tests de sÃ©curitÃ©
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”’ Run Trivy vulnerability scanner - Backend
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest'
        format: 'sarif'
        output: 'trivy-backend.sarif'

    - name: ğŸ”’ Run Trivy vulnerability scanner - Frontend
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest'
        format: 'sarif'
        output: 'trivy-frontend.sarif'

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-backend.sarif'

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-frontend.sarif'

  # DÃ©ploiement automatique (si configurÃ©)
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy
    needs: [build-and-push, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to production
      run: |
        echo "ğŸš€ Deployment would happen here"
        echo "This could be:"
        echo "  - SSH to production server"
        echo "  - Update docker-compose with new images"
        echo "  - Rolling update with docker stack deploy"
        echo "  - Kubernetes deployment"
        echo "  - etc."
        
        # Exemple de dÃ©ploiement SSH (dÃ©commentez et configurez selon vos besoins)
        # - name: ğŸ” Setup SSH
        #   uses: webfactory/ssh-agent@v0.7.0
        #   with:
        #     ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        #
        # - name: ğŸš€ Deploy via SSH
        #   run: |
        #     ssh -o StrictHostKeyChecking=no user@your-server.com << 'EOF'
        #       cd /path/to/selfstart
        #       git pull origin main
        #       docker-compose pull
        #       docker-compose up -d
        #     EOF

  # Notification du succÃ¨s/Ã©chec
  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify
    if: always()
    needs: [test, integration-test, build-and-push, security-scan, deploy]

    steps:
    - name: ğŸ“¢ Notify success
      if: ${{ needs.test.result == 'success' && needs.integration-test.result == 'success' }}
      run: |
        echo "âœ… SelfStart CI/CD completed successfully!"
        echo "ğŸ‰ All tests passed and images built"

    - name: ğŸ“¢ Notify failure
      if: ${{ needs.test.result == 'failure' || needs.integration-test.result == 'failure' }}
      run: |
        echo "âŒ SelfStart CI/CD failed!"
        echo "ğŸ” Check the logs for more details"

    # Optionnel : notification Slack/Discord/Email
    # - name: ğŸ“¬ Slack notification
    #   if: always()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     channel: '#selfstart'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
