name: ğŸ¤– Issue & PR Management

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, labeled, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  # Auto-labelling des issues
  auto-label-issues:
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Auto Label Issues
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Auto label by content
      uses: actions/github-script@v7
      with:
        script: |
          const issueBody = context.payload.issue.body.toLowerCase();
          const issueTitle = context.payload.issue.title.toLowerCase();
          const labels = [];
          
          // DÃ©tection automatique des types
          if (issueTitle.includes('bug') || issueBody.includes('bug') || issueBody.includes('erreur')) {
            labels.push('bug');
          }
          
          if (issueTitle.includes('feature') || issueBody.includes('feature') || issueBody.includes('fonctionnalitÃ©')) {
            labels.push('enhancement');
          }
          
          if (issueBody.includes('question') || issueTitle.includes('comment') || issueTitle.includes('how')) {
            labels.push('question');
          }
          
          if (issueBody.includes('documentation') || issueTitle.includes('doc')) {
            labels.push('documentation');
          }
          
          // DÃ©tection des composants
          if (issueBody.includes('caddy') || issueBody.includes('proxy')) {
            labels.push('caddy');
          }
          
          if (issueBody.includes('react') || issueBody.includes('frontend') || issueBody.includes('interface')) {
            labels.push('frontend');
          }
          
          if (issueBody.includes('api') || issueBody.includes('fastapi') || issueBody.includes('backend')) {
            labels.push('backend');
          }
          
          if (issueBody.includes('docker') || issueBody.includes('container')) {
            labels.push('docker');
          }
          
          // PrioritÃ©
          if (issueTitle.includes('urgent') || issueTitle.includes('critical')) {
            labels.push('priority: high');
          }
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: labels
            });
          }

  # Message de bienvenue pour les nouvelles issues
  welcome-issue:
    runs-on: ubuntu-latest
    name: ğŸ‘‹ Welcome New Issues
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
    - name: ğŸ‘‹ Comment welcome message
      uses: actions/github-script@v7
      with:
        script: |
          const welcomeMessage = `ğŸ‘‹ Merci d'avoir ouvert cette issue !
          
          **SelfStart Team** va examiner votre demande dans les plus brefs dÃ©lais.
          
          ğŸ“‹ **Pour nous aider Ã  mieux vous assister:**
          - [ ] VÃ©rifiez que votre issue n'existe pas dÃ©jÃ 
          - [ ] Fournissez des dÃ©tails prÃ©cis sur votre environnement
          - [ ] Incluez les logs pertinents si c'est un bug
          - [ ] Proposez une solution si vous en avez une
          
          ğŸš€ **Liens utiles:**
          - [ğŸ“– Documentation](https://github.com/kihw/selfstart#readme)
          - [ğŸ’¬ Discussions](https://github.com/kihw/selfstart/discussions)
          - [ğŸ› Signaler un bug](https://github.com/kihw/selfstart/issues/new?template=bug_report.md)
          - [âœ¨ Demander une fonctionnalitÃ©](https://github.com/kihw/selfstart/issues/new?template=feature_request.md)
          
          â­ **N'hÃ©sitez pas Ã  star le repository si SelfStart vous aide !**`;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.issue.number,
            body: welcomeMessage
          });

  # Auto-labelling des PRs
  auto-label-pr:
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Auto Label PRs
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Auto label by changes
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
          });
          
          const labels = [];
          const fileNames = files.map(file => file.filename);
          
          // DÃ©tection par fichiers modifiÃ©s
          if (fileNames.some(name => name.startsWith('frontend-loader/'))) {
            labels.push('frontend');
          }
          
          if (fileNames.some(name => name.startsWith('backend-api/'))) {
            labels.push('backend');
          }
          
          if (fileNames.some(name => name.includes('caddy') || name.includes('Caddyfile'))) {
            labels.push('caddy');
          }
          
          if (fileNames.some(name => name.includes('docker') || name.includes('Dockerfile'))) {
            labels.push('docker');
          }
          
          if (fileNames.some(name => name.includes('README') || name.includes('.md'))) {
            labels.push('documentation');
          }
          
          if (fileNames.some(name => name.includes('.github'))) {
            labels.push('ci/cd');
          }
          
          // Taille de la PR
          const totalChanges = files.reduce((acc, file) => acc + file.changes, 0);
          
          if (totalChanges < 50) {
            labels.push('size: small');
          } else if (totalChanges < 200) {
            labels.push('size: medium');
          } else {
            labels.push('size: large');
          }
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            });
          }

  # Message de bienvenue pour les nouvelles PRs
  welcome-pr:
    runs-on: ubuntu-latest
    name: ğŸ‘‹ Welcome New PRs
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    steps:
    - name: ğŸ‘‹ Comment welcome message
      uses: actions/github-script@v7
      with:
        script: |
          const welcomeMessage = `ğŸ‰ Merci pour cette Pull Request !
          
          **Votre contribution Ã  SelfStart est trÃ¨s apprÃ©ciÃ©e** ğŸ™
          
          âœ… **Checklist avant review:**
          - [ ] Les tests passent localement
          - [ ] Le code respecte les standards du projet
          - [ ] La documentation est mise Ã  jour si nÃ©cessaire
          - [ ] Les commits sont descriptifs
          - [ ] Les changements sont testÃ©s
          
          ğŸ”„ **Prochaines Ã©tapes:**
          1. **VÃ©rification automatique** - Les tests CI/CD vont dÃ©marrer
          2. **Review du code** - Un mainteneur va examiner votre PR
          3. **Tests supplÃ©mentaires** - Nous testerons en profondeur
          4. **Merge** - Si tout va bien, votre PR sera mergÃ©e !
          
          ğŸ“ **Tips pour une review rapide:**
          - DÃ©crivez clairement les changements effectuÃ©s
          - Expliquez pourquoi ces changements sont nÃ©cessaires
          - Fournissez des captures d'Ã©cran si c'est une modification visuelle
          - Ajoutez des tests si possible
          
          ğŸš€ **Merci encore pour votre contribution Ã  la communautÃ© SelfStart !**`;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: welcomeMessage
          });

  # Gestion des issues stale
  stale-management:
    runs-on: ubuntu-latest
    name: ğŸ§¹ Stale Issues Management
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ§¹ Mark stale issues
      uses: actions/stale@v8
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        stale-issue-message: |
          ğŸ“… Cette issue semble inactive depuis un moment.
          
          Pour garder le repository organisÃ©, nous marquons automatiquement les issues inactives.
          
          **Si cette issue est toujours d'actualitÃ©:**
          - Commentez pour la rÃ©activer
          - Ajoutez des informations supplÃ©mentaires
          - PrÃ©cisez si vous travaillez dessus
          
          **Sinon**, elle sera automatiquement fermÃ©e dans 7 jours.
          
          Merci de votre comprÃ©hension ! ğŸ™
        
        stale-pr-message: |
          ğŸ“… Cette Pull Request semble inactive depuis un moment.
          
          **Pour Ã©viter qu'elle soit fermÃ©e automatiquement:**
          - RÃ©pondez aux commentaires de review
          - Mettez Ã  jour le code si nÃ©cessaire
          - Confirmez que vous souhaitez continuer
          
          **Sinon**, elle sera fermÃ©e dans 7 jours pour garder le repository organisÃ©.
          
          Merci ! ğŸš€
        
        days-before-stale: 30
        days-before-close: 7
        stale-issue-label: 'stale'
        stale-pr-label: 'stale'
        exempt-issue-labels: 'pinned,security,enhancement'
        exempt-pr-labels: 'pinned,security'

  # RÃ©action automatique aux mots-clÃ©s
  auto-reactions:
    runs-on: ubuntu-latest
    name: ğŸ­ Auto Reactions
    if: github.event_name == 'issue_comment'
    
    steps:
    - name: ğŸ­ React to keywords
      uses: actions/github-script@v7
      with:
        script: |
          const comment = context.payload.comment.body.toLowerCase();
          
          // RÃ©actions positives
          if (comment.includes('merci') || comment.includes('thank you') || comment.includes('parfait')) {
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'heart'
            });
          }
          
          // RÃ©actions pour les bugs
          if (comment.includes('bug') || comment.includes('erreur') || comment.includes('problÃ¨me')) {
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
          }
          
          // RÃ©actions pour les fonctionnalitÃ©s
          if (comment.includes('feature') || comment.includes('idÃ©e') || comment.includes('amÃ©lioration')) {
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
          }
          
          // RÃ©actions pour les questions
          if (comment.includes('comment') || comment.includes('aide') || comment.includes('help')) {
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });
          }

# Programmation pour les tÃ¢ches stale
on:
  schedule:
    - cron: '0 9 * * 1' # Tous les lundis Ã  9h UTC
